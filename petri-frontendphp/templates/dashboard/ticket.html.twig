{% extends 'ticket_base.html.twig' %}

{% block title %}{{ 'ticket.title'|trans }}{% endblock %}

{% block content %}
<h2>{{ 'ticket.heading'|trans }}</h2>

{% if message %}
    <p class="error">{{ 'ticket.error'|trans }}: {{ message }}</p>
{% endif %}

<h3>{{ 'ticket.create_ticket'|trans }}</h3>
<form method="POST" enctype="multipart/form-data">
    <input type="hidden" name="create_ticket" value="1">
    <label>{{ 'ticket.subject'|trans }}: <input type="text" name="subject" required></label><br>
    <label>{{ 'ticket.message'|trans }}: <textarea name="message"></textarea></label><br>
    <label>{{ 'ticket.or_file'|trans }}: <input type="file" name="file"></label><br>
    <button type="submit">{{ 'ticket.submit_create'|trans }}</button>
</form>

<h3>{{ 'ticket.heading'|trans }}</h3>
<ul class="ticket-list">
{% for t in myTickets %}
    <li><a href="?ticket_id={{ t.id }}">{{ t.subject }} ({{ t.status }})</a></li>
{% else %}
    <li>{{ 'ticket.no_tickets'|trans }}</li>
{% endfor %}
</ul>

{% if selectedTicket %}
<h3>{{ 'ticket.chat_heading'|trans({'%id%': selectedTicket}) }}</h3>
<div class="chat-box">
{% for m in ticketMessages|reverse %}
    <p><strong>{{ m.SenderName }}:</strong><br>
    {% if m.is_image %}
        <img src="data:image/{{ m.image_type }};base64,{{ m.image_data }}"><br>
    {% else %}
        {{ m.text|nl2br }}
    {% endif %}
    </p>
{% endfor %}
</div>

<h4>{{ 'ticket.send_message'|trans }}</h4>
<form method="POST" enctype="multipart/form-data">
    <input type="hidden" name="ticket_id" value="{{ selectedTicket }}">
    <input type="hidden" name="send_message" value="1">
    <textarea name="message" required></textarea><br>
    <label>{{ 'ticket.or_file'|trans }}: <input type="file" name="file"></label><br>
    <button type="submit">{{ 'ticket.submit_send'|trans }}</button>
</form>

<h4>{{ 'ticket.close_ticket'|trans }}</h4>
<form method="POST">
    <input type="hidden" name="ticket_id" value="{{ selectedTicket }}">
    <input type="hidden" name="close_ticket" value="1">
    <button type="submit" style="background:red; color:white;">{{ 'ticket.close_ticket'|trans }}</button>
</form>
{% endif %}
{% endblock %}

